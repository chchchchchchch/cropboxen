<!doctype html>
<html lang="en">
<head><meta charset="UTF-8">

 <link rel="stylesheet" href="lib/css/svg.css">
 <link rel="stylesheet" href="lib/css/imgareaselect-animated.css">
 <link rel="stylesheet" href="lib/css/imgareaselect-default.css">

 <script src="lib/js/jquery-3.3.1.js"></script>
 <script src="lib/js/jquery.imgareaselect.js"></script>
 <script src="lib/js/jquery.md5.js"></script>
 <script src="lib/js/panzoom.js"></script>
 <script>   var srcUrl = "https://github.sfds/adsdsdf/bla.svg"
          var srcWidth = 11916;
              var srcX = -1646; // xInit 
              var srcY = -1617; // yInit
 </script>
 <script>

   var svgNS = "http://www.w3.org/2000/svg";
   var panzoomSave;

   var zoomX = 0;
   var zoomY = 0;
   var zoomScale = 1;

   var x1,x2,y1,y2;
   var offsetX = 0;
   var offsetY = 0;
   var offsetScale = 1;

   var editMode = false;

   var resizeTimeout;

   var windowWidth = $(window).width();
   var canvasWidth = $('div#svg').width();
   var srcScale = canvasWidth / srcWidth;

   var sArea;

// ------------------------------------------------------------------------- //
   $(document).ready(function(){
// ------------------------------------------------------------------------- //
     sArea = $('#viewport')
             .imgAreaSelect({handles:true,
                             instance:true,
                             keys:true,
                             onSelectEnd:function(){recalculateSelection();}
                            });

// ------------------------------------------------------------------------- //
     var area = panzoom(document.getElementById('svg'));
     area.on('transform', function(e) {

             zoomX = area.getTransform().x;
             zoomY = area.getTransform().y;
             zoomScale = area.getTransform().scale;

             offsetX = zoomX;
             offsetScale = zoomScale;

     });
     area.pause();
// ------------------------------------------------------------------------- //
     window.addEventListener("keydown", function(e) {
      // console.log(e.keyCode);
      // space and arrow keys and return and tab
      if([32,37,38,39,40,13,9].indexOf(e.keyCode) > -1) {
          e.preventDefault();
      }
     }, false); 
  // -------------------------------------------------------------------- //
     $(window).bind('keydown',function(e) {

       keyCode = e.keyCode || e.which;

       if ( keyCode == 9 && editMode != true ) {

            editMode = true;
            panzoomSave = $('#svg').attr("style"); // SAVE
         // WORKAROUND: MOVE PANZOOM TRANSFORM 
         //             TO SUB ELEMENTS (MAKE CLICKABLE)
            pzmatrix = $('#svg').css("transform"); 
            $('div.layer').each(function() {
               $(this).css({ 'transform':pzmatrix});
            });
            $('#svg').removeAttr("style");
            $('#selections').addClass('onTop');

       }

       if ( editMode != true ) {

        if ( keyCode == 32 ) {
         if (  area.isPaused() ) { 
               sArea.setOptions({disable:true})
               area.resume();
         }
        }

        if ( keyCode == 13 ) {

             svgX = Math.round((sArea.getSelection().x1 - zoomX) 
                                / srcScale / zoomScale);
             svgY = Math.round((sArea.getSelection().y1 - zoomY) 
                               / srcScale / zoomScale);
             svgW = Math.round(wSrc / zoomScale);
             svgH = Math.round(hSrc / zoomScale);

             addSelection(svgX,svgY,svgW,svgH);
         }

       }
     })
  // -------------------------------------------------------------------- //
     $(window).bind('keyup',function(e) { 

               keyCode = e.keyCode || e.which;

               if ( keyCode == 32 ) {

                 area.pause();
                 sArea.setOptions({disable:false});

               }

               if ( keyCode == 9 ) {

                 editMode = false;
              // RESTORE PANZOOM TRANSFORM
                 $('div.layer').each(function() {
                    $(this).css({ 'transform':''});
                 });
                 $('#svg').attr("style",panzoomSave);
                 panzoomSave = ''; // RESET
                 $('#selections').removeClass('onTop');

               }
     })
  // -------------------------------------------------------------------- //
  // https://alvarotrigo.com/blog/
  // -> firing-resize-event-only-once-when-resizing-is-finished/
  window.addEventListener('resize',function() { 
                           clearTimeout(resizeTimeout);
                           resizeTimeOut = setTimeout(doneResizing(),500);});
// ------------------------------------------------------------------------- //
   })
// ------------------------------------------------------------------------- //

</script>
<script>

// ------------------------------------------------------------------------- //
   function doneResizing(){ resizeSelection(sArea);recalculateSelection();
                            offsetX=0;offsetScale=1; }
// ------------------------------------------------------------------------- //
   function recalculateSelection() { // recalculateCropBox (?)

      x1 = sArea.getSelection().x1;y1 = sArea.getSelection().y1;
      x2 = sArea.getSelection().x2;y2 = sArea.getSelection().y2;

      canvasWidth = $('div#svg').width();
      srcScale = canvasWidth / srcWidth;

      offsetX = zoomX;
      offsetScale = zoomScale;

      xSrc = Math.round(sArea.getSelection().x1     / srcScale);
      ySrc = Math.round(sArea.getSelection().y1     / srcScale);
      wSrc = Math.round(sArea.getSelection().width  / srcScale);
      hSrc = Math.round(sArea.getSelection().height / srcScale);

      windowWidth = $(window).width(); // SAVE WHEN RESIZE IS DONE

   }
// ------------------------------------------------------------------------- //
   function resizeSelection(sArea) {


//      windowScale = $(window).width() / windowWidth;
/*
        sArea.setSelection(x1 * windowScale,y1 * windowScale,
                           x2 * windowScale,y2 * windowScale);

*/
/*
        sArea.setSelection(x1 * windowScale * displayScale,
                           y1 * windowScale * displayScale,
                           x2 * windowScale * displayScale,
                           y2 * windowScale * displayScale);
*/

        windowScale = $(window).width() / windowWidth;
console.log(offsetScale);
        xS = x1 * windowScale * offsetScale;        // X SELECTION
        yS = y1 * windowScale;        // X SELECTION
        wS = (x2 - x1) * windowScale; // WIDTH SELECTION
        hS = (y2 - y1) * windowScale; // HEIGHT SELECTION

        sArea.setSelection(xS,yS,xS+wS,yS+hS);

        sArea.update();

   }
// ------------------------------------------------------------------------- //
   function rmSelection(sID) { // TODO: post
                               sID.remove(); }
// ------------------------------------------------------------------------- //
   function editSelection(sID) {

     //svgX = Number($(sID).attr("x"));
       svgX = getCoords(sID)[0];
     //svgY = Number($(sID).attr("y"));
       svgY = getCoords(sID)[1];
       svgW = Number($(sID).attr("width"));
       svgH = Number($(sID).attr("height"));
       sID.remove();

       canvasWidth = $('div#svg').width();
       srcScale = canvasWidth / srcWidth;

       xS = svgX;
       yS = svgY;
       wS = Math.round(svgW * srcScale * zoomScale);
       hS = Math.round(svgH * srcScale * zoomScale);
 
       sArea.setSelection(xS,yS,xS+wS,yS+hS);
       sArea.setOptions({show:true,enable:true});
       sArea.update();

   }
// ------------------------------------------------------------------------- //
   function addSelection(X,Y,W,H) {

      cB = document.createElementNS(svgNS,"rect");
      iD = $.md5(X + "" + Y + "" + "" + W + "" + ""+  H).substr(0,11);
      cB.setAttributeNS(null,"x",X);
      cB.setAttributeNS(null,"y",Y);
      cB.setAttributeNS(null,"width",W);
      cB.setAttributeNS(null,"height",H);
      cB.setAttributeNS(null,"id",iD);
      cB.setAttributeNS(null,"class","croparea");
    //cB.setAttributeNS(null,"onclick","rmSelection(this)");
      cB.setAttributeNS(null,"onclick","editSelection(this)");
      cB.setAttributeNS(null,"onmouseover","showSelection(this)");
      document.getElementById("showCropBoxes").appendChild(cB);

      // TODO: post

   }
// ------------------------------------------------------------------------- //
   function showSelection(sID) {

     x = srcX + Number($(sID).attr("x"));
     y = srcY + Number($(sID).attr("y"));
     w = $(sID).attr("width");
     h = $(sID).attr("height");
     mdshcode = "% SHOW: " + srcUrl + 
                " --area=" + x + 
                ":"        + y +
                ":"        + w +
                ":"        + h;
     $('#showmdsh').val(mdshcode);

   }
// ------------------------------------------------------------------------- //   
   function visibleLayers() {




   }
// ------------------------------------------------------------------------- //
  // https://stackoverflow.com/questions/5598743/
 // -> finding-elements-position-relative-to-the-document
// ----------------------------------------------------------------------- // 
  function getCoords(elem) { // crossbrowser version

       var box = elem.getBoundingClientRect();
   
       var body = document.body;
       var docEl = document.documentElement;
   
       var scrollTop = window.pageYOffset || docEl.scrollTop || body.scrollTop;
       var scrollLeft = window.pageXOffset || docEl.scrollLeft || body.scrollLeft;
   
       var clientTop = docEl.clientTop || body.clientTop || 0;
       var clientLeft = docEl.clientLeft || body.clientLeft || 0;
   
       var top  = box.top +  scrollTop - clientTop;
       var left = box.left + scrollLeft - clientLeft;
   
     //return { top: Math.round(top), left: Math.round(left) };
       return [Math.round(left),Math.round(top)];
   }
// ------------------------------------------------------------------------- //
 </script>
 <script>
// ------------------------------------------------------------------------- //   
   $(document).ready(function() {
     $('.layerSwitch').click(function() {
       layerName = $(this).attr('id');
       if( $(this).is(':checked')) {
          $('#svg > div.layer.' + layerName).each(function() {
             $(this).show();
          });
       } else {
          $('#svg > div.layer.' + layerName).each(function() {
             $(this).hide();
          });   
       }
     });
   });
// ------------------------------------------------------------------------- //
 </script>


</head>
<body>

<div class="svg" id="svg">
<div class="layer">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
     width="100%" viewBox="0 0 11916 7087" id="fillBackground">
<rect x="0" y="0" width="11916" height="7087" 
      fill="#ff0000" fill-opacity="0.4" stroke="none"></rect>
</svg></div>
<div class="layer src 5acfd7" style="background-image:url('_/68b329/7c56127c_00010_5acfd7.svg');z-index:0001;"></div>
<div class="layer src 65f439" style="background-image:url('_/68b329/7c56127c_00021_65f439.svg');z-index:0002;"></div>
<div class="layer src f27510" style="background-image:url('_/68b329/7c56127c_00031_f27510.svg');z-index:0003;"></div>
<div class="layer src 947d72" style="background-image:url('_/68b329/7c56127c_00041_947d72.svg');z-index:0004;"></div>
<div class="layer" id="selections">
<svg xmlns="http://www.w3.org/2000/svg"
     xmlns:xlink="http://www.w3.org/1999/xlink"
     width="100%" viewBox="0 0 11916 7087"
     id="showCropBoxes">
</svg></div>
</div>

<div id="viewport" style="position:fixed;width:100vw;height:100vh;z-index:100000"></div>

<div id="layercontrol">
<input type="checkbox" id="5acfd7" class="layerSwitch" checked="checked">fdsfs <br>
<input type="checkbox" id="65f439" class="layerSwitch" checked="checked">fdsfs <br>
<input type="checkbox" id="f27510" class="layerSwitch" checked="checked">fdsfs <br>
<input type="checkbox" id="947d72" class="layerSwitch" checked="checked">fdsfs <br>
</div>

<div class="showmdsh">
<textarea name="text" wrap="soft" id="showmdsh"></textarea>
</div>

</body>
</html>

