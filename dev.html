<!doctype html>
<html lang="en">
<head><meta charset="UTF-8">

 <link rel="stylesheet" href="lib/css/svg.css">
 <link rel="stylesheet" href="lib/css/imgareaselect-animated.css">
 <link rel="stylesheet" href="lib/css/imgareaselect-default.css">

 <script src="lib/js/jquery-3.3.1.js"></script>
 <script src="lib/js/jquery.imgareaselect.js"></script>
 <script src="lib/js/jquery.md5.js"></script>
 <script src="lib/js/panzoom.js"></script>
 <script>   var svgUrl = "https://github.sfds/adsdsdf/bla.svg"
          var svgWidth = 11916;
             var zeroX = -1646; // xInit 
             var zeroY = -1617; // yInit
 </script>
 <script>

   var pzSave;
   var panX = 0;var panY = 0;var pzScale = 1;

   var sArea;
   var x1,x2,y1,y2;

   var editMode = false;
   var svgNS = "http://www.w3.org/2000/svg";

   var resizing = false;var resizeTimeout;

 //var windowWidth = $(window).width();
 //var canvasWidth = $('div#svg').width();
 //var svgScale = $('div#svg').width() / svgWidth;
   var svgScale;

// ------------------------------------------------------------------------- //
   $(document).ready(function(){
// ------------------------------------------------------------------------- //
   var windowWidth = $(window).width();
   var svgScale = $('div#svg').width() / svgWidth;
   console.log(svgScale);
// ------------------------------------------------------------------------- //
   sArea = $('#viewport')
           .imgAreaSelect({handles:true,
                           instance:true,
                           onSelectEnd:function(){/*calculateCropBox();*/}
                          });

// ------------------------------------------------------------------------- //
   var panZoom = panzoom(document.getElementById('svg'));
   panZoom.on('transform', function(e) {

           panX = panZoom.getTransform().x;
           panY = panZoom.getTransform().y;
           pzScale = panZoom.getTransform().scale;

   });
   panZoom.pause();
// ------------------------------------------------------------------------- //
     window.addEventListener("keydown", function(e) {
      // console.log(e.keyCode);
      // space and arrow keys and return and tab
      if([32,37,38,39,40,13,9].indexOf(e.keyCode) > -1) {
          e.preventDefault();
      }
     }, false); 
  // -------------------------------------------------------------------- //
     $(window).bind('keydown',function(e) {

       keyCode = e.keyCode || e.which;

       if ( keyCode == 9 && editMode != true ) {

            editMode = true;
            pzSave = $('#svg').attr("style"); // SAVE
         // WORKAROUND: MOVE PANZOOM TRANSFORM 
         //             TO SUB ELEMENTS (MAKE CLICKABLE)
            pzMatrix = $('#svg').css("transform"); 
            $('div.layer').each(function() {
              $(this).css({ 'transform':pzMatrix});
            });
            $('#svg').removeAttr("style");
            $('#selections').addClass('onTop');

       }

       if ( editMode != true ) {

        if ( keyCode == 32 ) {
         if (  panZoom.isPaused() ) { 
               sArea.setOptions({disable:true})
               panZoom.resume();
         }
        }

        if ( keyCode == 13 ) {

             svgScale = $('div#svg').width() / svgWidth;
             svgX = (sArea.getSelection().x1 - panX) / svgScale / pzScale;
             svgY = (sArea.getSelection().y1 - panY) / svgScale / pzScale;
           //svgW =  wSrc / pzScale;
           //svgH =  hSrc / pzScale;
           //svgW = ((sArea.getSelection().x2 - panX) / svgScale / pzScale)
           //      - ((sArea.getSelection().x1 - panX) / svgScale / pzScale);
           //svgH = ((sArea.getSelection().y2 - panY) / svgScale / pzScale)
           //      - ((sArea.getSelection().y1 - panY) / svgScale / pzScale);
             svgW = sArea.getSelection().width / svgScale / pzScale;
             svgH = sArea.getSelection().height / svgScale / pzScale;

             addCropBox(svgX,svgY,svgW,svgH);
         }

       }
     })
  // -------------------------------------------------------------------- //
     $(window).bind('keyup',function(e) { 

               keyCode = e.keyCode || e.which;

               if ( keyCode == 32 ) {

                 panZoom.pause();
                 sArea.setOptions({disable:false});

               }

               if ( keyCode == 9 ) {

                 editMode = false;
              // RESTORE PANZOOM TRANSFORM
                 $('div.layer').each(function() {
                    $(this).css({ 'transform':''});
                 });
                 $('#svg').attr("style",pzSave);
                 pzSave = ''; // RESET
                 $('#selections').removeClass('onTop');

               }
     })
  // -------------------------------------------------------------------- //
  // https://alvarotrigo.com/blog/
  // -> firing-resize-event-only-once-when-resizing-is-finished/
  window.addEventListener('resize',function() { 
                           if ( resizing != true ) {
                                pushSelection();
                                resizing = true;
                           }
                           clearTimeout(resizeTimeout);
                           resizeTimeOut = setTimeout(doneResizing(),800);});
// ------------------------------------------------------------------------- //
   })
// ------------------------------------------------------------------------- //
   function pushSelection() {

console.log("pushSelection svgScale:" + svgScale);

    //W = wSrc/pzScale;H = hSrc/pzScale;
    //svgScale = $('div#svg').width() / svgWidth;
      X = (sArea.getSelection().x1-panX)/svgScale/pzScale;
      Y = (sArea.getSelection().y1-panY)/svgScale/pzScale;
/*    W = ((sArea.getSelection().x2-panX)/svgScale/pzScale);
         - ((sArea.getSelection().x1-panX)/svgScale/pzScale);
      H = ((sArea.getSelection().y2-panY)/svgScale/pzScale);
         - ((sArea.getSelection().y1-panY)/svgScale/pzScale);
*/
      W = sArea.getSelection().width  / svgScale / pzScale;
      H = sArea.getSelection().height / svgScale / pzScale;

      cB = document.createElementNS(svgNS,"rect");
      cB.setAttributeNS(null,"x",X);cB.setAttributeNS(null,"y",Y);
      cB.setAttributeNS(null,"width",W);cB.setAttributeNS(null,"height",H);
      cB.setAttributeNS(null,"id","tmp");
    //cB.setAttributeNS(null,"class","croparea");
      cB.setAttributeNS(null,"style","visibility:hidden");
      document.getElementById("showCropBoxes").appendChild(cB);

   }
// ------------------------------------------------------------------------- //
   function popSelection() {

      sID = document.getElementById('tmp');

      svgX = getCoords(sID)[0];
      svgY = getCoords(sID)[1];
      svgW = Number($(sID).attr("width"));
      svgH = Number($(sID).attr("height"));
      sID.remove();

      canvasWidth = $('div#svg').width();
      svgScale = canvasWidth / svgWidth;

      x = svgX;y = svgY;
      w = svgW * svgScale * pzScale;
      h = svgH * svgScale * pzScale;
 
      sArea.setSelection(x,y,x+w,y+h);
      sArea.setOptions({show:true,enable:true});
      sArea.update();

   }
// ------------------------------------------------------------------------- //
   function doneResizing(){ resizing = false;
                            popSelection();
                          /*calculateCropBox();*/ 
                            windowWidth = $(window).width(); }
// ------------------------------------------------------------------------- //
/* function calculateCropBox() {

      x1 = sArea.getSelection().x1;y1 = sArea.getSelection().y1;
      x2 = sArea.getSelection().x2;y2 = sArea.getSelection().y2;

      canvasWidth = $('div#svg').width();
      svgScale = canvasWidth / svgWidth;
      
      xSrc = Math.round(sArea.getSelection().x1     / svgScale);
      ySrc = Math.round(sArea.getSelection().y1     / svgScale);
      wSrc = Math.round(sArea.getSelection().width  / svgScale);
      hSrc = Math.round(sArea.getSelection().height / svgScale);

      windowWidth = $(window).width(); // SAVE WHEN RESIZE IS DONE

   } */
// ------------------------------------------------------------------------- //
   function editCropBox(sID) {

       borderWidth = 10;

       svgX = getCoords(sID)[0];
       svgY = getCoords(sID)[1];
       svgW = Number($(sID).attr("width"));
       svgH = Number($(sID).attr("height"));
       sID.remove();

       canvasWidth = $('div#svg').width();
       svgScale = canvasWidth / svgWidth;

       x = svgX + (borderWidth/2 * svgScale * pzScale);
       y = svgY + (borderWidth/2 * svgScale * pzScale);
       w = Math.round(svgW * svgScale * pzScale);
       h = Math.round(svgH * svgScale * pzScale);
 
       sArea.setSelection(x,y,x+w,y+h);
       sArea.setOptions({show:true});
       sArea.update();
     //calculateCropBox();

   }
// ------------------------------------------------------------------------- //
   function rmCropBox(sID) { // TODO: post
                               sID.remove(); }
// ------------------------------------------------------------------------- //
   function addCropBox(X,Y,W,H) {

      cB = document.createElementNS(svgNS,"rect");
      iD = $.md5(X + "" + Y + "" + "" + W + "" + ""+  H).substr(0,11);
      cB.setAttributeNS(null,"x",X);
      cB.setAttributeNS(null,"y",Y);
      cB.setAttributeNS(null,"width",W);
      cB.setAttributeNS(null,"height",H);
      cB.setAttributeNS(null,"id",iD);
      cB.setAttributeNS(null,"class","croparea");
    //cB.setAttributeNS(null,"onclick","rmCropBox(this)");
      cB.setAttributeNS(null,"onclick","editCropBox(this)");
      cB.setAttributeNS(null,"onmouseover","showCropBox(this)");
      document.getElementById("showCropBoxes").appendChild(cB);

      // TODO: post

   }
// ------------------------------------------------------------------------- //
   function showCropBox(sID) {

     x = Math.round(zeroX + Number($(sID).attr("x")));
     y = Math.round(zeroY + Number($(sID).attr("y")));
     w = Math.round($(sID).attr("width"));
     h = Math.round($(sID).attr("height"));
     mdshcode = "% SHOW: " + svgUrl + 
                " --panZoom=" + x + 
                ":"        + y +
                ":"        + w +
                ":"        + h;
     $('#showmdsh').val(mdshcode);

   }
// ------------------------------------------------------------------------- //   
   function visibleLayers() {




   }
// ------------------------------------------------------------------------- //
  // https://stackoverflow.com/questions/5598743/
 // -> finding-elements-position-relative-to-the-document
// ----------------------------------------------------------------------- // 
  function getCoords(elem) { // crossbrowser version

       var box = elem.getBoundingClientRect();
       var body = document.body;
       var docEl = document.documentElement;
       var scrollTop = window.pageYOffset 
                       || docEl.scrollTop || body.scrollTop;
       var scrollLeft = window.pageXOffset 
                        || docEl.scrollLeft || body.scrollLeft;
       var clientTop = docEl.clientTop || body.clientTop || 0;
       var clientLeft = docEl.clientLeft || body.clientLeft || 0; 
       var top  = box.top +  scrollTop - clientTop;
       var left = box.left + scrollLeft - clientLeft;
   
     //return { top: Math.round(top), left: Math.round(left) };
     //return [Math.round(left),Math.round(top)];
       return [left,top];
   }
// ------------------------------------------------------------------------- //
 </script>
 <script>
// ------------------------------------------------------------------------- //   
   $(document).ready(function() {
     $('.layerSwitch').click(function() {
       layerName = $(this).attr('id');
       if( $(this).is(':checked')) {
          $('#svg > div.layer.' + layerName).each(function() {
             $(this).show();
          });
       } else {
          $('#svg > div.layer.' + layerName).each(function() {
             $(this).hide();
          });   
       }
     });
   });
// ------------------------------------------------------------------------- //
 </script>


</head>
<body>

<div class="svg" id="svg">
<div class="layer">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
     width="100%" viewBox="0 0 11916 7087" id="fillBackground">
<rect x="0" y="0" width="11916" height="7087" 
      fill="#ff0000" fill-opacity="0.4" stroke="none"></rect>
</svg></div>
<div class="layer src 5acfd7" style="background-image:url('_/68b329/7c56127c_00010_5acfd7.svg');z-index:0001;"></div>
<div class="layer src 65f439" style="background-image:url('_/68b329/7c56127c_00021_65f439.svg');z-index:0002;"></div>
<div class="layer src f27510" style="background-image:url('_/68b329/7c56127c_00031_f27510.svg');z-index:0003;"></div>
<div class="layer src 947d72" style="background-image:url('_/68b329/7c56127c_00041_947d72.svg');z-index:0004;"></div>
<div class="layer" id="selections">
<svg xmlns="http://www.w3.org/2000/svg"
     xmlns:xlink="http://www.w3.org/1999/xlink"
     width="100%" viewBox="0 0 11916 7087"
     id="showCropBoxes">
</svg></div>
</div>

<div id="viewport" style="position:fixed;width:100vw;height:100vh;z-index:100000"></div>

<div id="layercontrol">
<input type="checkbox" id="5acfd7" class="layerSwitch" checked="checked">fdsfs <br>
<input type="checkbox" id="65f439" class="layerSwitch" checked="checked">fdsfs <br>
<input type="checkbox" id="f27510" class="layerSwitch" checked="checked">fdsfs <br>
<input type="checkbox" id="947d72" class="layerSwitch" checked="checked">fdsfs <br>
</div>

<div class="showmdsh">
<textarea name="text" wrap="soft" id="showmdsh"></textarea>
</div>

</body>
</html>

